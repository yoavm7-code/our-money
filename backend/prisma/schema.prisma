// Our Money - Database Schema
// PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------------------------------
// Household (shared by two users)
// --------------------------------------------
model Household {
  id        String   @id @default(uuid())
  name      String   @default("Our Household")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users       User[]
  accounts    Account[]
  categories  Category[]
  transactions Transaction[]
  documents   Document[]
  rules       CategoryRule[]
  loans       Loan[]
  savings     Saving[]
  goals              Goal[]
  forexAccounts      ForexAccount[]
  forexTransfers     ForexTransfer[]
  budgets            Budget[]
  recurringPatterns  RecurringPattern[]
}

// --------------------------------------------
// Users (two users per household)
// --------------------------------------------
model User {
  id               String   @id @default(uuid())
  email            String   @unique
  passwordHash     String   @map("password_hash")
  name             String?
  countryCode      String?  @map("country_code") // ISO 3166-1 alpha-2 (e.g. IL, US)
  avatarPath       String?  @map("avatar_path")  // path to uploaded avatar image (legacy)
  avatarData       String?  @map("avatar_data") @db.Text  // base64-encoded avatar image
  avatarMime       String?  @map("avatar_mime")  // MIME type e.g. image/png
  twoFactorSecret  String?  @map("two_factor_secret") // TOTP secret
  twoFactorEnabled Boolean  @default(false) @map("two_factor_enabled")
  dashboardConfig  Json?    @map("dashboard_config") // widget layout, colors, order
  householdId      String   @map("household_id")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@index([householdId])
}

// --------------------------------------------
// Accounts (bank, credit card, insurance, investment)
// --------------------------------------------
model Account {
  id                  String   @id @default(uuid())
  householdId         String   @map("household_id")
  name                String
  type                AccountType
  provider            String?  // e.g. "bank-xyz", "visa", "pension-fund"
  externalId          String?  @unique @map("external_id") // from open banking / API
  balance             Decimal  @default(0) @db.Decimal(14, 2)
  balanceDate         DateTime? @map("balance_date") @db.Date  // date when the initial balance was recorded
  currency            String   @default("ILS")
  isActive            Boolean  @default(true) @map("is_active")
  syncToken           String?  @map("sync_token") // for incremental sync
  linkedBankAccountId String?  @map("linked_bank_account_id") // for credit cards: which bank account charges go to
  metadata            Json?    // provider-specific (encrypted credentials ref, etc.)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  household         Household     @relation(fields: [householdId], references: [id], onDelete: Cascade)
  transactions      Transaction[]
  linkedBankAccount Account?      @relation("CreditCardToBank", fields: [linkedBankAccountId], references: [id])
  linkedCreditCards Account[]     @relation("CreditCardToBank")

  @@index([householdId])
  @@index([type])
}

enum AccountType {
  BANK
  CREDIT_CARD
  INSURANCE
  PENSION
  INVESTMENT
  CASH
}

// --------------------------------------------
// Categories (default + custom per household)
// --------------------------------------------
model Category {
  id           String   @id @default(uuid())
  householdId  String   @map("household_id")
  name         String
  slug         String   // e.g. "groceries", "salary"
  icon         String?  // emoji or icon name
  color        String?  // hex
  isDefault    Boolean  @default(false) @map("is_default")
  isIncome     Boolean  @default(false) @map("is_income")
  excludeFromExpenseTotal Boolean @default(false) @map("exclude_from_expense_total") // e.g. credit card charges – avoid double-count when also uploading card statements
  parentId     String?  @map("parent_id")
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  household    Household     @relation(fields: [householdId], references: [id], onDelete: Cascade)
  parent       Category?    @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children     Category[]   @relation("CategoryHierarchy")
  transactions Transaction[]
  rules        CategoryRule[]
  budgets      Budget[]

  @@unique([householdId, slug])
  @@index([householdId])
}

// --------------------------------------------
// Transactions (income & expenses)
// --------------------------------------------
model Transaction {
  id                 String    @id @default(uuid())
  householdId        String    @map("household_id")
  accountId         String    @map("account_id")
  categoryId        String?   @map("category_id")
  date              DateTime  @db.Date
  description       String
  amount            Decimal   @db.Decimal(14, 2) // positive = income, negative = expense (for installments = payment made)
  currency          String    @default("ILS")
  source            TransactionSource
  externalId        String?   @unique @map("external_id") // from API sync
  documentId        String?   @map("document_id") // if extracted from upload
  rawText           String?   @map("raw_text") // original line from statement/OCR
  totalAmount       Decimal?  @map("total_amount") @db.Decimal(14, 2) // for installments: full price (e.g. 1950)
  installmentCurrent Int?     @map("installment_current") // e.g. 2 (payment 2 of 3)
  installmentTotal   Int?     @map("installment_total") // e.g. 3
  isRecurring        Boolean  @default(false) @map("is_recurring") // fixed expense or fixed income
  metadata          Json?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  household  Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  account    Account   @relation(fields: [accountId], references: [id], onDelete: Restrict)
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  document   Document? @relation(fields: [documentId], references: [id], onDelete: SetNull)

  @@index([householdId, date])
  @@index([accountId])
  @@index([categoryId])
  @@index([source])
}

enum TransactionSource {
  MANUAL
  UPLOAD
  API
}

// --------------------------------------------
// Documents (uploaded files + extracted data)
// --------------------------------------------
model Document {
  id           String   @id @default(uuid())
  householdId  String   @map("household_id")
  fileName     String   @map("file_name")
  mimeType     String   @map("mime_type")
  storagePath  String   @map("storage_path") // S3 key or local path
  fileSize     Int      @map("file_size")
  status       DocumentStatus @default(PENDING)
  ocrText      String?  @map("ocr_text") @db.Text
  extractedJson Json?   @map("extracted_json") // AI-extracted transactions
  errorMessage String?  @map("error_message")
  uploadedAt   DateTime @default(now()) @map("uploaded_at")
  processedAt  DateTime? @map("processed_at")

  household    Household     @relation(fields: [householdId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([householdId])
  @@index([status])
}

enum DocumentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  PENDING_REVIEW  // duplicates found – waiting for user to confirm which to import
}

// --------------------------------------------
// Rules for auto-categorization (learn from user)
// --------------------------------------------
model CategoryRule {
  id          String   @id @default(uuid())
  householdId String   @map("household_id")
  categoryId  String   @map("category_id")
  pattern     String   // regex or keyword (e.g. "SUPER*", "AMAZON")
  patternType String   @default("contains") @map("pattern_type") // contains, startsWith, regex
  priority    Int      @default(0) // higher = applied first
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  category  Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([householdId])
  @@index([categoryId])
}

// --------------------------------------------
// Loans (mortgage, personal loans, etc.)
// --------------------------------------------
model Loan {
  id              String    @id @default(uuid())
  householdId     String    @map("household_id")
  name            String    // e.g. "Mortgage", "Car loan"
  lender          String?   // e.g. "Bank Hapoalim"
  originalAmount  Decimal   @map("original_amount") @db.Decimal(14, 2)
  remainingAmount Decimal   @map("remaining_amount") @db.Decimal(14, 2)
  interestRate    Decimal?  @map("interest_rate") @db.Decimal(5, 2) // annual %
  monthlyPayment  Decimal?  @map("monthly_payment") @db.Decimal(14, 2)
  startDate       DateTime? @map("start_date") @db.Date
  endDate         DateTime? @map("end_date") @db.Date
  currency        String    @default("ILS")
  notes           String?
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@index([householdId])
}

// --------------------------------------------
// Savings goals (emergency fund, vacation, etc.)
// --------------------------------------------
model Saving {
  id            String    @id @default(uuid())
  householdId   String    @map("household_id")
  name          String    // e.g. "Emergency fund", "Vacation"
  targetAmount  Decimal?  @map("target_amount") @db.Decimal(14, 2)
  currentAmount Decimal   @default(0) @map("current_amount") @db.Decimal(14, 2)
  interestRate  Decimal?  @map("interest_rate") @db.Decimal(5, 2)
  startDate     DateTime? @map("start_date") @db.Date
  targetDate    DateTime? @map("target_date") @db.Date
  currency      String    @default("ILS")
  notes         String?
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@index([householdId])
}

// --------------------------------------------
// Goals (financial goals with AI recommendations)
// --------------------------------------------
model Goal {
  id              String    @id @default(uuid())
  householdId     String    @map("household_id")
  name            String    // e.g. "Vacation fund", "New car"
  targetAmount    Decimal   @map("target_amount") @db.Decimal(14, 2)
  currentAmount   Decimal   @default(0) @map("current_amount") @db.Decimal(14, 2)
  targetDate      DateTime? @map("target_date") @db.Date
  icon            String?   // emoji
  color           String?   // hex accent color
  priority        Int       @default(0) // higher = more important
  monthlyTarget   Decimal?  @map("monthly_target") @db.Decimal(14, 2) // auto-calculated or user-set
  aiTips          String?   @map("ai_tips") @db.Text // cached AI recommendations
  aiTipsUpdatedAt DateTime? @map("ai_tips_updated_at")
  currency        String    @default("ILS")
  notes           String?
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@index([householdId])
}

// --------------------------------------------
// Forex Accounts (user's foreign currency accounts)
// --------------------------------------------
model ForexAccount {
  id          String   @id @default(uuid())
  householdId String   @map("household_id")
  name        String   // e.g. "USD Savings", "EUR Travel"
  currency    String   // e.g. "USD", "EUR"
  balance     Decimal  @default(0) @db.Decimal(14, 2)
  provider    String?  // e.g. "Bank Hapoalim", "Interactive Brokers"
  accountNum  String?  @map("account_num")
  notes       String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  household  Household       @relation(fields: [householdId], references: [id], onDelete: Cascade)
  transfers  ForexTransfer[]

  @@index([householdId])
}

// --------------------------------------------
// Forex Transfers (buy/sell/transfer currency)
// --------------------------------------------
model ForexTransfer {
  id             String   @id @default(uuid())
  householdId    String   @map("household_id")
  forexAccountId String?  @map("forex_account_id")
  type           ForexTransferType // BUY, SELL, TRANSFER
  fromCurrency   String   @map("from_currency")
  toCurrency     String   @map("to_currency")
  fromAmount     Decimal  @map("from_amount") @db.Decimal(14, 2)
  toAmount       Decimal  @map("to_amount") @db.Decimal(14, 2)
  exchangeRate   Decimal  @map("exchange_rate") @db.Decimal(14, 6)
  fee            Decimal? @db.Decimal(14, 2)
  date           DateTime @db.Date
  description    String?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  household    Household     @relation(fields: [householdId], references: [id], onDelete: Cascade)
  forexAccount ForexAccount? @relation(fields: [forexAccountId], references: [id], onDelete: SetNull)

  @@index([householdId])
  @@index([forexAccountId])
  @@index([date])
}

enum ForexTransferType {
  BUY
  SELL
  TRANSFER
}

// --------------------------------------------
// Budgets (monthly budget per category)
// --------------------------------------------
model Budget {
  id          String   @id @default(uuid())
  householdId String   @map("household_id")
  categoryId  String   @map("category_id")
  amount      Decimal  @db.Decimal(14, 2) // monthly budget limit
  currency    String   @default("ILS")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  category  Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([householdId, categoryId])
  @@index([householdId])
}

// --------------------------------------------
// Recurring patterns (auto-detected)
// --------------------------------------------
model RecurringPattern {
  id            String   @id @default(uuid())
  householdId   String   @map("household_id")
  description   String   // matched description pattern
  amount        Decimal  @db.Decimal(14, 2) // typical amount
  type          String   // 'income' or 'expense'
  frequency     String   @default("monthly") // monthly, weekly, etc.
  categoryId    String?  @map("category_id")
  accountId     String?  @map("account_id")
  lastSeenDate  DateTime @map("last_seen_date") @db.Date
  occurrences   Int      @default(1) // how many times detected
  isConfirmed   Boolean  @default(false) @map("is_confirmed") // user confirmed
  isDismissed   Boolean  @default(false) @map("is_dismissed") // user dismissed
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@index([householdId])
}
